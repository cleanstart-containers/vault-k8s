# Vault Server Deployment (Required for vault-k8s)
apiVersion: v1
kind: Namespace
metadata:
  name: vault
  labels:
    app: vault
---
apiVersion: v1
kind: Service
metadata:
  name: vault
  namespace: vault
  labels:
    app: vault
spec:
  type: ClusterIP
  ports:
  - port: 8200
    targetPort: 8200
    protocol: TCP
    name: http
  selector:
    app: vault
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vault
  namespace: vault
  labels:
    app: vault
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vault
  template:
    metadata:
      labels:
        app: vault
    spec:
      containers:
      - name: vault
        image: hashicorp/vault:latest
        imagePullPolicy: IfNotPresent
        args: ["server", "-dev", "-dev-listen-address=0.0.0.0:8200"]
        ports:
        - containerPort: 8200
          name: http
          protocol: TCP
        env:
        - name: VAULT_DEV_ROOT_TOKEN_ID
          value: "root"
        - name: VAULT_ADDR
          value: "http://0.0.0.0:8200"
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        readinessProbe:
          httpGet:
            path: /v1/sys/health
            port: 8200
          initialDelaySeconds: 5
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /v1/sys/health
            port: 8200
          initialDelaySeconds: 30
          periodSeconds: 30
---
# Vault-K8s Deployment
apiVersion: v1
kind: Namespace
metadata:
  name: vault-k8s-test
  labels:
    app: vault-k8s
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-k8s
  namespace: vault-k8s-test
  labels:
    app: vault-k8s
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: vault-k8s
  labels:
    app: vault-k8s
rules:
  # Core Kubernetes resources
  - apiGroups: [""]
    resources:
      - pods
      - services
      - endpoints
      - configmaps
      - events
      - namespaces
      - secrets
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["apps"]
    resources: ["deployments", "daemonsets", "replicasets", "statefulsets"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
  # Vault-k8s CRDs (if using CRDs)
  - apiGroups: ["vault.hashicorp.com"]
    resources:
      - "*"
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  # Leader election
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
  # Webhook configuration
  - apiGroups: ["admissionregistration.k8s.io"]
    resources: ["mutatingwebhookconfigurations", "validatingwebhookconfigurations"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: vault-k8s
  labels:
    app: vault-k8s
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: vault-k8s
subjects:
  - kind: ServiceAccount
    name: vault-k8s
    namespace: vault-k8s-test
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vault-k8s
  namespace: vault-k8s-test
  labels:
    app: vault-k8s
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vault-k8s
  template:
    metadata:
      labels:
        app: vault-k8s
    spec:
      serviceAccountName: vault-k8s
      containers:
      - name: vault-k8s
        image: cleanstart/vault-k8s:latest-dev
        imagePullPolicy: IfNotPresent
        command: ["/usr/bin/vault-k8s"]
        args:
        - agent-inject
        env:
        - name: SSL_CERT_FILE
          value: /etc/ssl/certs/ca-certificates.crt
        - name: AGENT_INJECT_VAULT_ADDR
          value: "http://vault.vault.svc.cluster.local:8200"  # Vault server address
        - name: AGENT_INJECT_LISTEN
          value: ":8080"  # Webhook server listen address
        - name: AGENT_INJECT_LOG_LEVEL
          value: "info"  # Log level: trace, debug, info, warn, error
        ports:
        - containerPort: 8080
          name: webhook
          protocol: TCP
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          runAsNonRoot: true
          runAsUser: 1000
          readOnlyRootFilesystem: false
      securityContext:
        fsGroup: 1000
---
apiVersion: v1
kind: Service
metadata:
  name: vault-k8s
  namespace: vault-k8s-test
  labels:
    app: vault-k8s
spec:
  type: ClusterIP
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
    name: http
  selector:
    app: vault-k8s